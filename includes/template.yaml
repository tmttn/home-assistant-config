#-
#  _                       _       _
# | |_ ___ _ __ ___  _ __ | | __ _| |_ ___
# | __/ _ \ '_ ` _ \| '_ \| |/ _` | __/ _ \
# | ||  __/ | | | | | |_) | | (_| | ||  __/
#  \__\___|_| |_| |_| .__/|_|\__,_|\__\___|
#                   |_|
#
#- from github.com/tmttn/home-assistant-config

#  ____
# / ___|  ___ _ __  ___  ___  _ __ ___
# \___ \ / _ \ '_ \/ __|/ _ \| '__/ __|
#  ___) |  __/ | | \__ \ (_) | |  \__ \
# |____/ \___|_| |_|___/\___/|_|  |___/
#
- sensor:
    - name: Count automations
      unique_id: count_automations
      icon: mdi:autorenew
      state: "{{ states.automation | count }}"

    - name: Count scripts
      unique_id: count_scripts
      icon: mdi:script-text-outline
      state: "{{ states.script| count }}"

    - name: Count device trackers
      unique_id: count_device_trackers
      icon: mdi:map-marker
      state: "{{ states.device_tracker | count }}"

    - name: Count binary sensors
      unique_id: count_binary_sensors
      icon: mdi:unfold-more-horizontal
      state: "{{ states.binary_sensor| count }}"

    - name: Count sensors
      unique_id: count_sensors
      icon: mdi:resistor
      state: "{{ states.sensor | count }}"

    - name: Count switches
      unique_id: count_switches
      icon: mdi:light-switch
      state: "{{ states.switch | count }}"

    - name: Count zones
      unique_id: count_zones
      icon: mdi:map-marker-radius
      state: "{{ states.zone | count }}"

    - name: Count input booleans
      unique_id: count_input_booleans
      icon: mdi:toggle-switch
      state: "{{ states.input_boolean | count }}"

    - name: Count input numbers
      unique_id: count_input_numbers
      icon: mdi:numeric
      state: "{{ states.input_number | count }}"

    - name: Count input texts
      unique_id: count_input_texts
      icon: mdi:alphabetical
      state: "{{ states.input_text | count }}"

    - name: Count input selects
      unique_id: count_input_selects
      icon: mdi:view-list
      state: "{{ states.input_select | count }}"

    - name: Count input datetimes
      unique_id: count_input_datetimes
      icon: mdi:calendar-clock
      state: "{{ states.input_datetime | count }}"

    - name: Favorite playlist of nearest person
      unique_id: favorite_playlist_of_nearest_person
      state: >
        {% if is_state_attr("proximity.home", "nearest", "Tom iPhone") %}
        2GPRgfioefDRYgV17cDlsr
        {% else %}
        2GPRgfioefDRYgV17cDlsr
        {% endif %}

    - name: TV Volume
      unique_id: tv_volume
      unit_of_measurement: "%"
      state: >
        {{ state_attr("media_player.tv", "volume_level") }}

    - name: Timestamp start of today
      unique_id: timestamp_start_of_today
      unit_of_measurement: "s"
      state: >
        {{ as_timestamp(now().replace(hour=0).replace(minute=0).replace(second=0)) }}

    - name: Time at work prognosis
      unique_id: time_at_work_prognosis
      unit_of_measurement: h
      state: >
        {% set day = [now().weekday(), 4] | min %}
        {% set t_total = states("sensor.time_at_work_this_week")|float(default=0) %}
        {% set t_today = states("sensor.time_at_work_today")|float(default=0) %}
        {% set hours_per_day_including_today = t_total / (day + 1) %}
        {% set hours_per_day_excluding_today = (t_total - t_today ) / (day + 10**-16) %}
        {% set seven_oclock = as_timestamp(now().replace(hour=19).replace(minute=0).replace(second=0)) %}

        {% if t_today > hours_per_day_excluding_today
              or (not is_state("person.tom", "Work") and t_today > 0)
              or (as_timestamp(now()) > seven_oclock)
              or day == 0
              or now().weekday() > 4
              or 5 * hours_per_day_including_today > 40 %}
          {% set hours_per_day = hours_per_day_including_today %}
        {% else %}
          {% set hours_per_day = hours_per_day_excluding_today %}
        {% endif %}

        {{ (5 * hours_per_day)|round(2) }}

    - name: N days last month
      unique_id: n_days_last_month
      state: >
        {% set start_of_month = now().replace(day=1) %}
        {% set last_month = now().month - 1 %}
        {% set last_month_year = now().year %}
        {% if last_month == 0 %}
          {% set last_month = 12 %}
          {% set last_month_year = now().year - 1 %}
        {% endif %}
        {% set start_of_last_month = start_of_month.replace(month=last_month, year=last_month_year) %}
        {{ ((start_of_month - start_of_last_month).total_seconds() / 86400) | round }}

    - name: Daily Power
      unique_id: daily_power
      unit_of_measurement: kWh
      state: >
        {{ states("sensor.daily_power_offpeak")|float(default=0) + states("sensor.daily_power_peak")|float(default=0) }}

    - name: Monthly Power
      unique_id: monthly_power
      unit_of_measurement: kWh
      state: >
        {{ states("sensor.monthly_power_offpeak")|float(default=0) + states("sensor.monthly_power_peak")|float(default=0) }}

    - name: Monthly Power (Last period)
      unique_id: monthly_power_last_period
      unit_of_measurement: kWh
      state: >
        {{ state_attr("sensor.monthly_power_offpeak", "last_period")|float(default=0) + state_attr("sensor.monthly_power_peak", "last_period")|float(default=0) }}

    - name: Monthly Power Cost (Last period)
      unique_id: monthly_power_cost_last_period
      unit_of_measurement: €
      state: >
        {{ (state_attr("sensor.monthly_power_offpeak", "last_period")|float(default=0) * states("sensor.electricity_price_offpeak")|float(default=0)
            + state_attr("sensor.monthly_power_peak", "last_period")|float(default=0) * states("sensor.electricity_price_peak")|float(default=0)) | round(2) }}

    - name: Gas price
      unique_id: gas_price
      unit_of_measurement: €/m³
      state: >
        {{ 0.940036171 }}

    - name: Daily Gas Cost
      unique_id: daily_gas_cost
      unit_of_measurement: €
      state: >
        {{ (states("sensor.daily_gas")|float(default=0) *states("sensor.gas_price")|float(default=0)) | round(2) }}

    - name: Monthly Gas Cost
      unique_id: monthly_gas_cost
      unit_of_measurement: €
      state: >
        {{ (states("sensor.monthly_gas")|float(default=0) * states("sensor.gas_price")|float(default=0)) | round(2) }}

    - name: Monthly Gas (Last period)
      unique_id: monthly_gas_last_period
      unit_of_measurement: kWh
      state: >
        {{ state_attr("sensor.monthly_gas", "last_period")|float(default=0) }}

    - name: Monthly Gas Cost (Last period)
      unique_id: monthly_gas_cost_last_period
      unit_of_measurement: €
      state: >
        {{ (state_attr("sensor.monthly_gas", "last_period")|float(default=0) * states("sensor.gas_price")|float(default=0)) | round(2) }}

    - name: Electricity price offpeak
      unique_id: electricity_price_offpeak
      unit_of_measurement: €/kWh
      state: >
        {{ 0.265939 }}

    - name: Electricity price peak
      unique_id: electricity_price_peak
      unit_of_measurement: €/kWh
      state: >
        {{ 0.284039 }}

    - name: Electricity injection price
      unique_id: electricity_price_injection
      unit_of_measurement: €/kWh
      state: >
        {{ 0.0949 }}

    - name: Daily Power Cost
      unique_id: daily_power_cost
      unit_of_measurement: €
      state: >
        {{ (states("sensor.daily_power_offpeak")|float(default=0) * states("sensor.electricity_price_offpeak")|float(default=0)
            + states("sensor.daily_power_peak")|float(default=0) * states("sensor.electricity_price_peak")|float(default=0)) | round(2) }}

    - name: Monthly Power Cost
      unique_id: monthly_power_cost
      unit_of_measurement: €
      state: >
        {{ (states("sensor.monthly_power_offpeak")|float(default=0) * states("sensor.electricity_price_offpeak")|float(default=0)
            + states("sensor.monthly_power_peak")|float(default=0) * states("sensor.electricity_price_peak")|float(default=0)) | round(2) }}

    - name: Fixed daily energy cost (gas and power)
      unique_id: daily_energy_fixed_cost
      unit_of_measurement: €
      state: >
        {% set _ = states("sensor.date") %}
        {{ 1.05668 + 0.43719 }}

    - name: Fixed monthly energy cost (gas and power)
      unique_id: monthly_energy_fixed_cost
      unit_of_measurement: €
      state: >
        {{ states("sensor.daily_energy_fixed_cost")|float(default=0) * now().day }}

    - name: Fixed energy cost (gas and power) (Last period)
      unique_id: monthly_energy_fixed_cost_last_period
      unit_of_measurement: €
      state: >
        {{ states("sensor.daily_energy_fixed_cost")|float(default=0) * states("sensor.n_days_last_month")|int(default=0) }}

    - name: Nearest iPhone's notify service
      unique_id: nearest_iphone_notify
      state: >
        {% if is_state("person.tom", "home") and is_state("person.tanja", "home") %}
          notify.all_iphones
        {% elif is_state_attr("proximity.home", "nearest", "Tom iPhone") %}
          notify.mobile_app_bizzyphone
        {% else %}
          notify.mobile_app_t_phone
        {% endif %}

    - name: Half an hour before alarm
      unique_id: half_hour_before_alarm
      state: >
        {% set t_alarm = state_attr("input_datetime.alarm_clock", "timestamp") | int %}
        {% set t_start = states("sensor.timestamp_start_of_today") | int %}
        {% set half_hour_before_alarm = t_alarm + t_start - 60 * 30 %}
        {{ half_hour_before_alarm | timestamp_custom("%H:%M", True) }}

    - name: Ten minutes before alarm
      unique_id: ten_minutes_before_alarm
      state: >
        {% set t_alarm = state_attr("input_datetime.alarm_clock", "timestamp") | int %}
        {% set t_start = states("sensor.timestamp_start_of_today") | int %}
        {% set before_alarm = t_alarm + t_start - 60 * 10 %}
        {{ before_alarm | timestamp_custom("%H:%M", True) }}

    - name: Lights on total hours
      unique_id: lights_on_total_hours
      unit_of_measurement: h
      state: >
        {{ states('sensor.hours_bedroom_lights_have_been_on_last_7_days')|float(default=0) * 3
            + states('sensor.hours_guest_bedroom_lights_have_been_on_last_7_days')|float(default=0) * 1
            + states('sensor.hours_living_room_lights_have_been_on_last_7_days')|float(default=0) * 10
            + states('sensor.hours_toilet_light_has_been_on_last_7_days')|float(default=0) * 1
            + states('sensor.hours_bathroom_lights_have_been_on_last_7_days')|float(default=0) * 4
            + states('sensor.hours_kitchen_lights_have_been_on_last_7_days')|float(default=0) * 3
            + states('sensor.hours_terrace_lights_have_been_on_last_7_days')|float(default=0) * 3
            + states('sensor.hours_outside_lights_have_been_on_last_7_days')|float(default=0) * 3 }}

    - name: Lights on total kWh
      unique_id: lights_on_total_kwh
      unit_of_measurement: h
      state: >
        {{ states('sensor.lights_on_total_hours')|float(default=0) * 5.4 / 1000 }}

    - name: Temperature living room
      unique_id: temperature_living_room
      unit_of_measurement: "°C"
      state: '{{state_attr("climate.living_room", "current_temperature")}}'

    - name: Temperature bedroom
      unique_id: temperature_bedroom
      unit_of_measurement: "°C"
      state: '{{state_attr("climate.bedroom", "current_temperature")}}'

    - name: Temperature bathroom
      unique_id: temperature_bathroom
      unit_of_measurement: "°C"
      state: '{{state_attr("climate.bathroom", "current_temperature")}}'

    - name: Temperature kitchen
      unique_id: temperature_kitchen
      unit_of_measurement: "°C"
      state: '{{state_attr("climate.kitchen", "current_temperature")}}'

    - name: Temperature bedroom Marthe
      unique_id: temperature_bedroom_marthe
      unit_of_measurement: "°C"
      state: '{{state_attr("climate.bedroom_marthe", "current_temperature")}}'

    - name: Temperature storage
      unique_id: temperature_storage
      unit_of_measurement: "°C"
      state: '{{state_attr("climate.storage", "current_temperature")}}'

    - name: Temperature hall
      unique_id: temperature_hall
      unit_of_measurement: "°C"
      state: '{{state_attr("climate.hall", "current_temperature")}}'

    - name: Temperature guest bedroom
      unique_id: temperature_guest_bedroom
      unit_of_measurement: "°C"
      state: '{{state_attr("climate.guest_bedroom", "current_temperature")}}'

    - name: Total grid export
      unique_id: total_grid_export
      unit_of_measurement: kWh
      state: '{{states("sensor.p1_meter_total_power_export_t1")|float(default=0) + states("sensor.p1_meter_total_power_export_t2")|float(default=0)}}'

#  ____  _                          ____
# | __ )(_)_ __   __ _ _ __ _   _  / ___|  ___ _ __  ___  ___  _ __ ___
# |  _ \| | '_ \ / _` | '__| | | | \___ \ / _ \ '_ \/ __|/ _ \| '__/ __|
# | |_) | | | | | (_| | |  | |_| |  ___) |  __/ | | \__ \ (_) | |  \__ \
# |____/|_|_| |_|\__,_|_|   \__, | |____/ \___|_| |_|___/\___/|_|  |___/
#                           |___/
- binary_sensor:
    - name: Someone is showering or taking a bath
      unique_id: someone_showing
      state: >
        {% set humidity = states("sensor.multi_sensor_bathroom_humidity") | float(0) %}
        {% set treshold = 1.05 * state_attr("sensor.humidity_bathroom_stats", "median") | float(0) %}
        {% set derivative = states("sensor.humidity_bathroom_derivative") | float(0) %}
        {{ humidity > treshold and derivative > 0.25 }}

    - name: Someone is showering in the storage
      unique_id: someone_showing_storage
      state: >
        {% set humidity = states("sensor.multi_sensor_storage_humidity") | float(0) %}
        {% set treshold = 1.05 * state_attr("sensor.humidity_storage_stats", "median") | float(0) %}
        {% set derivative = states("sensor.humidity_storage_derivative") | float(0) %}
        {{ humidity > treshold and derivative > 0.25 }}

    - name: Any motion detected
      unique_id: motion_detected
      state: >
        {{ is_state("binary_sensor.activity_in_kitchen", "on")
            or is_state("binary_sensor.activity_in_living_room", "on")
            or is_state("binary_sensor.activity_in_hall", "on")
            or is_state("binary_sensor.activity_in_toilet", "on")
            or is_state("binary_sensor.activity_in_bathroom", "on")
            or is_state("binary_sensor.activity_in_guest_bedroom", "on") }}

    - name: Any motion detected in last hour
      unique_id: motion_detected_in_last_hour
      state: >
        {{ is_state("binary_sensor.motion_detected", "on") }}
      delay_off: "01:00:00"

    - name: Someone in the house in the last hour
      unique_id: someone_in_the_house_in_last_hour
      state: >
        {{ is_state("binary_sensor.motion_detected_in_last_hour", "on")
            or is_state("group.persons", "home") }}

    - name: Activity in the bathroom
      unique_id: activity_in_bathroom
      state: >
        {{ is_state("binary_sensor.someone_showering", "on") }}
      delay_off: "00:03:00"

    - name: Activity in the living room
      unique_id: activity_in_living_room
      state: >
        {{ is_state("binary_sensor.motion_sensor_living_room", "on")
            or is_state("media_player.tv", "on")
            or is_state("binary_sensor.openclose_back_door", "on")
            or is_state("binary_sensor.openclose_living_room_door", "on") }}
      delay_off: "00:20:00"

    - name: Activity at the toilet
      unique_id: activity_in_toilet
      state: >
        {{ is_state("binary_sensor.motion_sensor_toilet", "on") }}
      delay_off: "00:05:00"

    - name: Activity in the kitchen
      unique_id: activity_in_kitchen
      state: >
        {{ is_state("binary_sensor.motion_sensor_kitchen", "on") }}
      delay_off: "00:05:00"

    - name: Activity in the storage
      unique_id: activity_in_storage
      state: >
        {{ is_state("binary_sensor.openclose_storage_door", "on")
            or is_state("binary_sensor.someone_showering_storage", "on")}}
      delay_off: "00:05:00"

    - name: Activity in the hall
      unique_id: activity_in_hall
      state: >
        {{ is_state("binary_sensor.motion_sensor_lower_hall", "on")
            or is_state("binary_sensor.motion_sensor_lower_hall_2", "on")
            or is_state("binary_sensor.motion_sensor_upper_hall", "on")
            or is_state("binary_sensor.openclose_front_door", "on")
            or is_state("binary_sensor.openclose_living_room_door", "on") }}
      delay_off: "00:01:00"

    - name: Activity in the guest bedroom
      unique_id: activity_in_guest_bedroom
      state: >
        {{ is_state("binary_sensor.motion_sensor_guest_bedroom", "on") }}
      delay_off: "00:01:00"

    - name: Activity outside the bedroom
      unique_id: activity_outside_bedroom
      state: >
        {{ is_state("binary_sensor.activity_in_hall", "on")
            or is_state("binary_sensor.activity_in_living_room", "on")
            or is_state("binary_sensor.activity_in_toilet", "on")
            or is_state("binary_sensor.activity_in_kitchen", "on")
            or is_state("binary_sensor.activity_in_bathroom", "on")
            or is_state("binary_sensor.activity_in_storage", "on") }}
      delay_off: "00:01:00"

    - name: Washing machine
      unique_id: washing_machine
      state: >
        {{ is_state("sensor.washing_machine_status", "running") }}
      delay_off: "00:01:00"
      icon: >
        {% if is_state("binary_sensor.washing_machine", "on") %}
          mdi:washing-machine
        {% else %}
          mdi:washing-machine-off
        {% endif %}

    - name: Dishwasher
      unique_id: dishwasher
      state: >
        {{ states("sensor.dishwasher_current_consumption") | float(0) > 3 }}
      delay_off: "00:03:00"
      icon: >
        {% if is_state("binary_sensor.dishwasher", "on") %}
          mdi:dishwasher
        {% else %}
          mdi:dishwasher-off
        {% endif %}

    - name: Espresso machine
      unique_id: espresso_machine
      state: >
        {{ states("sensor.espresso_machine_current_consumption") | float(0) > 3 }}
      delay_off: "00:03:00"
      icon: >
        {% if is_state("binary_sensor.espresso_machine", "on") %}
          mdi:coffee-maker
        {% else %}
          mdi:coffee-maker
        {% endif %}

    - name: Tumble dryer
      unique_id: tumble_dryer
      state: >
        {{ states("sensor.tumble_dryer_current_consumption") | float(0) > 350 }}
      delay_off: "00:10:00"
      icon: >
        {% if is_state("binary_sensor.tumble_dryer", "on") %}
          mdi:tumble-dryer
        {% else %}
          mdi:tumble-dryer-off
        {% endif %}

    - name: Worked enough today
      unique_id: worked_enough_today
      icon: mdi:briefcase
      state: >
        {{ states("sensor.time_at_work_today") | float(0) > 8 }}

    - name: Any light is on
      unique_id: any_light_on
      state: >
        {% set automatic_lights_on = is_state("light.automatic_lights", "on") %}
        {% set bedroom_lights_on = is_state("light.bedroom_lights", "on") %}
        {% set living_room_lights_on = is_state("light.living_room_lights", "on") %}
        {% set bathroom_lights_on = is_state("light.bathroom_lights", "on") %}
        {% set guest_bedroom_lights_on = is_state("light.guest_bedroom_lights", "on") %}
        {{ automatic_lights_on or bedroom_lights_on or living_room_lights_on or bathroom_lights_on or guest_bedroom_lights_on }}

    - name: Anything is on
      unique_id: anything_on
      state: >
        {% set light_on = is_state("binary_sensor.any_light_on", "on") %}
        {% set tv_on = is_state("media_player.tv", "on") %}
        {{ light_on or tv_on }}

    - name: Vacuum day today
      unique_id: vacuum_day
      # XXX: was '("Mon", "Wed", "Sun")'  pre-corona because now we're mostly at home
      state: >
        {{ as_timestamp(now()) | timestamp_custom("%a") in ("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun") }}

    - name: No one is home
      unique_id: no_one_home
      state: >
        {{ not is_state("person.tom", "home")
            and not is_state("person.tanja", "home") }}

    - name: Humidity bathroom trend
      unique_id: humidity_bathroom_trend
      state: >
        {{ (states('sensor.multi_sensor_bathroom_humidity') | float(0)) > (states('sensor.multi_sensor_bathroom_humidity') | float(0)) }}
      # Note: This is a simplified version. For proper trend detection, consider using the trend integration via UI

    - name: Humidity storage trend
      unique_id: humidity_storage_trend
      state: >
        {{ (states('sensor.multi_sensor_storage_humidity') | float(0)) > (states('sensor.multi_sensor_storage_humidity') | float(0)) }}
      # Note: This is a simplified version. For proper trend detection, consider using the trend integration via UI

#  ____          _ _       _
# / ___|_      _(_) |_ ___| |__   ___  ___
# \___ \ \ /\ / / | __/ __| '_ \ / _ \/ __|
#  ___) \ V  V /| | || (__| | | |  __/\__ \
# |____/ \_/\_/ |_|\__\___|_| |_|\___||___/
#
- switch:
    - name: Vacuum mode
      unique_id: vacuum_mode
      state: >
        {{ is_state("vacuum.robot_vacuum", "cleaning")}}
      turn_on:
        - action: vacuum.start
          target:
            entity_id: vacuum.robot_vacuum
      turn_off:
        - action: vacuum.return_to_base
          target:
            entity_id: vacuum.robot_vacuum

#  ____  _                          ____
# | __ )(_)_ __   __ _ _ __ _   _  / ___|  ___ _ __  ___  ___  _ __ ___
# |  _ \| | '_ \ / _` | '__| | | | \___ \ / _ \ '_ \/ __|/ _ \| '__/ __|
# | |_) | | | | | (_| | |  | |_| |  ___) |  __/ | | \__ \ (_) | |  \__ \
# |____/|_|_| |_|\__,_|_|   \__, | |____/ \___|_| |_|___/\___/|_|  |___/
#                           |___/
#
- binary_sensor:
    - name: "Someone is showering or taking a bath"
      unique_id: someone_showing
      state: >
        {% set humidity = states("sensor.multi_sensor_bathroom_humidity") | float(0) %}
        {% set treshold = 1.05 * state_attr("sensor.humidity_bathroom_stats", "median") | float(0) %}
        {% set derivative = states("sensor.humidity_bathroom_derivative") | float(0) %}
        {{ humidity > treshold and derivative > 0.25 }}

    - name: "Someone is showering in the storage"
      unique_id: someone_showing_storage
      state: >
        {% set humidity = states("sensor.multi_sensor_storage_humidity") | float(0) %}
        {% set treshold = 1.05 * state_attr("sensor.humidity_storage_stats", "median") | float(0) %}
        {% set derivative = states("sensor.humidity_storage_derivative") | float(0) %}
        {{ humidity > treshold and derivative > 0.25 }}

    - name: "Any motion detected"
      unique_id: motion_detected
      state: >
        {{ is_state("binary_sensor.activity_in_kitchen", "on")
            or is_state("binary_sensor.activity_in_living_room", "on")
            or is_state("binary_sensor.activity_in_hall", "on")
            or is_state("binary_sensor.activity_in_toilet", "on")
            or is_state("binary_sensor.activity_in_bathroom", "on")
            or is_state("binary_sensor.activity_in_guest_bedroom", "on") }}

    - name: "Any motion detected in last hour"
      unique_id: motion_detected_in_last_hour
      state: >
        {{ is_state("binary_sensor.motion_detected", "on") }}
      delay_off:
        hours: 1

    - name: "Someone in the house in the last hour"
      unique_id: someone_in_the_house_in_last_hour
      state: >
        {{ is_state("binary_sensor.motion_detected_in_last_hour", "on")
            or is_state("group.persons", "home") }}

    - name: "Activity in the bathroom"
      unique_id: activity_in_bathroom
      state: >
        {{ is_state("binary_sensor.someone_showering", "on") }}
      delay_off:
        minutes: 3

    - name: "Activity in the living room"
      unique_id: activity_in_living_room
      state: >
        {{ is_state("binary_sensor.motion_sensor_living_room", "on")
            or is_state("media_player.tv", "on")
            or is_state("binary_sensor.openclose_back_door", "on")
            or is_state("binary_sensor.openclose_living_room_door", "on") }}
      delay_off:
        minutes: 20

    - name: "Activity at the toilet"
      unique_id: activity_in_toilet
      state: >
        {{ is_state("binary_sensor.motion_sensor_toilet", "on") }}
      delay_off:
        minutes: 5

    - name: "Activity in the kitchen"
      unique_id: activity_in_kitchen
      state: >
        {{ is_state("binary_sensor.motion_sensor_kitchen", "on") }}
      delay_off:
        minutes: 5

    - name: "Activity in the storage"
      unique_id: activity_in_storage
      state: >
        {{ is_state("binary_sensor.openclose_storage_door", "on")
            or is_state("binary_sensor.someone_showering_storage", "on")}}
      delay_off:
        minutes: 5

    - name: "Activity in the hall"
      unique_id: activity_in_hall
      state: >
        {{ is_state("binary_sensor.motion_sensor_lower_hall", "on")
            or is_state("binary_sensor.motion_sensor_lower_hall_2", "on")
            or is_state("binary_sensor.motion_sensor_upper_hall", "on")
            or is_state("binary_sensor.openclose_front_door", "on")
            or is_state("binary_sensor.openclose_living_room_door", "on") }}
      delay_off:
        minutes: 1

    - name: "Activity in the guest bedroom"
      unique_id: activity_in_guest_bedroom
      state: >
        {{ is_state("binary_sensor.motion_sensor_guest_bedroom", "on") }}
      delay_off:
        minutes: 1

    - name: "Activity outside the bedroom"
      unique_id: activity_outside_bedroom
      state: >
        {{ is_state("binary_sensor.activity_in_hall", "on")
            or is_state("binary_sensor.activity_in_living_room", "on")
            or is_state("binary_sensor.activity_in_toilet", "on")
            or is_state("binary_sensor.activity_in_kitchen", "on")
            or is_state("binary_sensor.activity_in_bathroom", "on")
            or is_state("binary_sensor.activity_in_storage", "on") }}
      delay_off:
        minutes: 1

    - name: "Washing machine"
      unique_id: washing_machine
      state: >
        {{ is_state("sensor.washing_machine_status", "running") }}
      delay_off:
        minutes: 1
      icon: >
        {% if is_state("binary_sensor.washing_machine", "on") %}
          mdi:washing-machine
        {% else %}
          mdi:washing-machine-off
        {% endif %}

    - name: "Dishwasher"
      unique_id: dishwasher
      state: >
        {{ states("sensor.dishwasher_current_consumption") | float(0) > 3 }}
      delay_off:
        minutes: 3
      icon: >
        {% if is_state("binary_sensor.dishwasher", "on") %}
          mdi:dishwasher
        {% else %}
          mdi:dishwasher-off
        {% endif %}

    - name: "Espresso machine"
      unique_id: espresso_machine
      state: >
        {{ states("sensor.espresso_machine_power") | float(0) > 3 }}
      delay_off:
        minutes: 3
      icon: mdi:coffee-maker

    - name: "Tumble dryer"
      unique_id: tumble_dryer
      state: >
        {{ states("sensor.tumble_dryer_current_consumption") | float(0) > 350 }}
      delay_off:
        minutes: 10
      icon: >
        {% if is_state("binary_sensor.tumble_dryer", "on") %}
          mdi:tumble-dryer
        {% else %}
          mdi:tumble-dryer-off
        {% endif %}

    - name: "Worked enough today"
      unique_id: worked_enough_today
      state: >
        {{ states("sensor.time_at_work_today") | float(0) > 8 }}
      icon: mdi:briefcase

    - name: "Any light is on"
      unique_id: any_light_on
      state: >
        {% set automatic_lights_on = is_state("light.automatic_lights", "on") %}
        {% set bedroom_lights_on = is_state("light.bedroom_lights", "on") %}
        {% set living_room_lights_on = is_state("light.living_room_lights", "on") %}
        {% set bathroom_lights_on = is_state("light.bathroom_lights", "on") %}
        {% set guest_bedroom_lights_on = is_state("light.guest_bedroom_lights", "on") %}
        {{ automatic_lights_on or bedroom_lights_on or living_room_lights_on or bathroom_lights_on or guest_bedroom_lights_on }}

    - name: "Anything is on"
      unique_id: anything_on
      state: >
        {% set light_on = is_state("binary_sensor.any_light_on", "on") %}
        {% set tv_on = is_state("media_player.tv", "on") %}
        {{ light_on or tv_on }}

    - name: "Vacuum day today"
      unique_id: vacuum_day
      # XXX: was '("Mon", "Wed", "Sun")'  pre-corona because now we're mostly at home
      state: >
        {{ as_timestamp(now()) | timestamp_custom("%a") in ("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun") }}

    - name: "No one is home"
      unique_id: no_one_home
      state: >
        {{ not is_state("person.tom", "home")
            and not is_state("person.tanja", "home") }}
