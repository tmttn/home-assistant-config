---
start_speakers:
  alias: Start speakers
  description: "Start a Spotify playlist on KEF speakers"
  fields:
    volume:
      description: "Volume at which to play"
      example: "0.3"
    source:
      description: "Which source to use on the speakers"
      example: "Wifi"
  sequence:
    - service: media_player.turn_on
      entity_id: media_player.kef
    - service: media_player.select_source
      entity_id: media_player.kef
      data_template:
        source: "{{ source }}"
    - wait_template: "{{ is_state('media_player.kef', 'on') }}"
      timeout: "00:01:00"
      continue_on_timeout: "false"
    - service: media_player.volume_set
      entity_id: media_player.kef
      data_template:
        volume_level: "{{ volume }}"

start_spotify:
  alias: Start Spotify
  description: "Start a Spotify playlist on KEF speakers"
  fields:
    source:
      description: "The name of the speaker as it appears in Spotify"
      example: "Sonos One"
    playlist:
      description: "The playlist URI from Spotify"
      example: "6rPTm9dYftKcFAfwyRqmDZ"
  sequence:
    - service: homeassistant.update_entity
      entity_id: media_player.spotify
    - wait_template: "{{ source in state_attr('media_player.spotify', 'source_list')  }}"
      timeout: "00:01:00"
      continue_on_timeout: "false"
    - service: media_player.select_source
      entity_id: media_player.spotify
      data_template:
        source: "{{ source }}"
    - service: spotify.play_playlist
      data_template:
        media_content_id: "spotify:playlist:{{ playlist }}"
        random_song: true
    - service: media_player.media_play
      entity_id: media_player.spotify

cozy_lights_living_room:
  alias: Set cozy lights in the living room
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.sphere_1
        hs_color: [336.293, 80.392]
    - service: light.turn_on
      data:
        entity_id: light.sphere_2
        hs_color: [299.147, 82.745]
    - service: light.turn_on
      data:
        entity_id: light.corner_living_room
        hs_color: [26.667, 88.235]
    - service: light.turn_on
      data:
        entity_id: light.ceiling_living_room
        hs_color: [268.267, 88.235]
    - service: light.turn_on
      data:
        entity_id: light.tv_led
        hs_color: [26.725, 89.804]

cozy_lights_bedroom:
  alias: Set cozy lights in the bedroom
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.bamboo
        hs_color: [299.72, 83.922]
    - service: light.turn_on
      data:
        entity_id: light.philips_go
        hs_color: [26.725, 89.804]
    - service: light.turn_on
      data:
        entity_id: light.lampan
        hs_color: [269.86, 84.314]
    - service: light.turn_on
      data:
        entity_id: light.ceiling_bedroom
        hs_color: [10.118, 100]

bright_lights_living_room:
  alias: Set bright lights in the living room
  sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.sphere_1
          - light.sphere_2
          - light.corner_living_room
          - light.ceiling_living_room
          - light.tv_led
        color_temp: 366

bright_lights_bedroom:
  alias: Set bright lights in the bedroom
  sequence:
    - service: light.turn_on
      data:
        entity_id:
          - light.bamboo
          - light.philips_go
          - light.lampan
          - light.ceiling_bedroom
        color_temp: 366

increase_brightness:
  alias: Increase the brightness of a group of lights
  fields:
    group:
      description: "The group to apply the light increase to."
      example: "group.living_room_lights"
  sequence:
    - service: light.turn_on
      data_template:
        entity_id: "{{ group }}"
        brightness: >
          {% set brightnesses = states |
            selectattr("state", "equalto", "on") |
            selectattr("entity_id", "in", state_attr(group, "entity_id")) |
            map(attribute="attributes.brightness") |
            list %}
          {% set tot = brightnesses|sum %}
          {% set len = brightnesses|length%}

          {% if len == 0 %}
            10
          {% elif tot/len < 20 %}
            128
          {% elif tot/len < 140 %}
            255
          {% else %}
            10
          {% endif %}

going_to_sleep:
  alias: Going to sleep
  sequence:
    - service: light.turn_off
      data:
        entity_id:
          - group.living_room_lights
          - group.bedroom_lights
    - service: input_boolean.turn_on
      entity_id: input_boolean.sleep_mode
