#!/bin/bash

#    ____ _
#   / ___| |__   ___  _ __ ___  ___
#  | |   | '_ \ / _ \| '__/ _ \/ __|
#  | |___| | | | (_) | | |  __/\__ \
#   \____|_| |_|\___/|_|  \___||___/
#
#- from github.com/tmttn/home-assistant-config

LOGFILE="/config/chores.log"
MAX_LOG_LINES=500

# Rotate log if it exceeds MAX_LOG_LINES
if [[ -f "$LOGFILE" ]] && [[ $(wc -l < "$LOGFILE") -gt $MAX_LOG_LINES ]]; then
    tail -n $MAX_LOG_LINES "$LOGFILE" > "${LOGFILE}.tmp"
    mv "${LOGFILE}.tmp" "$LOGFILE"
fi

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOGFILE"
}

# Redirect all stderr to log file as well
exec 2>> "$LOGFILE"

log "===== Starting chores script ====="
log "Working directory: $(pwd)"
log "Git status:"
git status >> "$LOGFILE" 2>&1 || log "git status failed"

set -e  # Exit immediately on error

log "Setting git config..."
git config --global user.name "Thomas Metten"
git config --global user.email "thomas.metten@gmail.com"

log "Setting up HTTPS authentication..."
if [[ -f /config/.git-token ]]; then
    GIT_TOKEN=$(cat /config/.git-token | tr -d '[:space:]')
    git remote set-url origin "https://${GIT_TOKEN}@github.com/tmttn/home-assistant-config.git"
else
    log "ERROR: /config/.git-token not found"
    exit 1
fi

log "Running commit-updates.py..."
python3 utils/commit-updates.py

log "Installing pip packages..."
pip3 -q install --root-user-action=ignore pyfiglet jinja2

log "Running ascii_art.py..."
python3 utils/ascii_art.py

log "Running update-readme.py..."
python3 utils/update-readme.py

log "Pushing to git..."
git push >> "$LOGFILE" 2>&1

log "Running commit-readme.sh..."
./utils/commit-readme.sh

log "Chores completed successfully"