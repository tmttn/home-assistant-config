#!/bin/bash

#    ____ _
#   / ___| |__   ___  _ __ ___  ___
#  | |   | '_ \ / _ \| '__/ _ \/ __|
#  | |___| | | | (_) | | |  __/\__ \
#   \____|_| |_|\___/|_|  \___||___/
#
#- from github.com/tmttn/home-assistant-config

LOGFILE="/config/chores.log"
MAX_LOG_LINES=500

# Rotate log if it exceeds MAX_LOG_LINES
if [[ -f "$LOGFILE" ]] && [[ $(wc -l < "$LOGFILE") -gt $MAX_LOG_LINES ]]; then
    tail -n $MAX_LOG_LINES "$LOGFILE" > "${LOGFILE}.tmp"
    mv "${LOGFILE}.tmp" "$LOGFILE"
fi

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOGFILE"
}

# Send notification to Home Assistant
ha_notify() {
    local title="$1"
    local message="$2"
    local HA_URL="http://supervisor/core"

    # Use Supervisor token if available (HA OS/Supervised), otherwise try local token
    if [[ -n "$SUPERVISOR_TOKEN" ]]; then
        local TOKEN="$SUPERVISOR_TOKEN"
    elif [[ -f /config/.ha-token ]]; then
        local TOKEN=$(cat /config/.ha-token | tr -d '[:space:]')
        HA_URL="http://localhost:8123"
    else
        log "No HA token available for notifications"
        return 1
    fi

    # Persistent notification (shows in HA sidebar)
    curl -sf -X POST \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"title\": \"$title\", \"message\": \"$message\", \"notification_id\": \"chores_git_error\"}" \
        "$HA_URL/api/services/persistent_notification/create" >> "$LOGFILE" 2>&1 || true

    # Mobile notification
    curl -sf -X POST \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"title\": \"$title\", \"message\": \"$message\"}" \
        "$HA_URL/api/services/notify/tom" >> "$LOGFILE" 2>&1 || true
}

# Redirect all stderr to log file as well
exec 2>> "$LOGFILE"

log "===== Starting chores script ====="
log "Working directory: $(pwd)"
log "Git status:"
git status >> "$LOGFILE" 2>&1 || log "git status failed"

set -e  # Exit immediately on error

log "Setting git config..."
git config --global user.name "Thomas Metten"
git config --global user.email "thomas.metten@gmail.com"

log "Setting up HTTPS authentication..."
if [[ -f /config/.git-token ]]; then
    GIT_TOKEN=$(cat /config/.git-token | tr -d '[:space:]')
    git remote set-url origin "https://${GIT_TOKEN}@github.com/tmttn/home-assistant-config.git"
else
    log "ERROR: /config/.git-token not found"
    exit 1
fi

# Stash any uncommitted changes before pulling
STASHED=false
if ! git diff --quiet || ! git diff --cached --quiet; then
    log "Stashing uncommitted changes..."
    git stash push -m "chores-auto-stash" >> "$LOGFILE" 2>&1
    STASHED=true
fi

log "Pulling latest changes..."
if ! git pull --rebase origin master >> "$LOGFILE" 2>&1; then
    log "ERROR: Pull failed, likely due to conflicts"
    log "Aborting rebase to restore clean state..."
    git rebase --abort >> "$LOGFILE" 2>&1 || true
    if $STASHED; then
        log "Restoring stashed changes..."
        git stash pop >> "$LOGFILE" 2>&1 || true
    fi
    log "Please resolve conflicts manually. Skipping push."
    ha_notify "⚠️ Git Conflict" "Config repo has conflicts that need manual resolution. Check /config/chores.log"
    exit 1
fi

# Restore stashed changes
if $STASHED; then
    log "Restoring stashed changes..."
    if ! git stash pop >> "$LOGFILE" 2>&1; then
        log "WARNING: Stash pop had conflicts, may need manual resolution"
    fi
fi

log "Running commit-updates.py..."
python3 utils/commit-updates.py

log "Installing pip packages..."
pip3 -q install --root-user-action=ignore pyfiglet jinja2

log "Running ascii_art.py..."
python3 utils/ascii_art.py

log "Running update-readme.py..."
python3 utils/update-readme.py

log "Pushing to git..."
git push >> "$LOGFILE" 2>&1

log "Running commit-readme.sh..."
./utils/commit-readme.sh

log "Chores completed successfully"